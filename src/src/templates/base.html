{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <script src="{% static 'js/alpine.min.js' %}" defer></script>
  <title>Sistema degestión de asistencias</title>

  <style>
    [x-cloak] { display: none !important; }

  </style>
</head>
<body class="h-100 bg-light">

<nav class="navbar text-with">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">
      Sistema de gestión de asistencia
    </span>
  </div>
</nav>
<main id="main-container" x-data="app()" x-cloak x-init="$nextTick(() => initialize())" class="pt-4 bg-light h-100">
  
  <div class="container">
    <div class="row">
      <div class="col d-flex flex-row align-self-center justify-content-center align-ittems-center">
        <img :src="data.defaultImage" x-show="data.formIsValid === null || !data.formIsValid" class="rounded-circle float-start" alt="...">
        <img :src="data.personal.photo" style="height: 200px; width: 200px;" x-show="data.formIsValid !== null && data.formIsValid" class="rounded-circle float-start" alt="...">
      </div>
    </div>
    <div class="row pt-2">
      <div class="col text-center" x-show="data.formIsValid === null">
        <h3>Marque su asistencia o salida escaneando el codigo QR de su carnet</h3>
      </div>
      <div class="col text-center text-success" x-show="data.formIsValid !== null && data.formIsValid">
        <h3 x-text="data.personal.name"></h3>
        <span x-text="data.personal.position"></span>
      </div>
    </div>
    <div class="row">
      <div class="col-6 offset-3">
        <input type="text" name="" id="" disabled readonly x-ref="idDisplayer"  :class="{'form-control': true, 'text-center': true, 'is-valid text-success fw-bold': data.formIsValid !== null && data.formIsValid,'is-invalid text-danger fw-bold': data.formIsValid !== null && !data.formIsValid}">
      </div>
    </div>
    <div class="row mt-4" x-show="data.formIsValid !== null && data.formIsValid">
      <div class="col-6 offset-3">
        <div class="alert alert-success text-center" >
          <strong x-text="data.greeting"></strong>
        </div>
      </div>
    </div>
    <div class="row mt-4" x-show="data.formIsValid !== null && !data.formIsValid">
      <div class="col-6 offset-3">
        <div class="alert alert-danger text-center" >
          <strong>Cédula invalida o no registrada. Vuelva a intentar o comuniquese con su administrador</strong>
        </div>
      </div>
    </div>
  </div>
  <form action="{% url 'clocking.checking' %}" method="post" id="checkingForm">
    {% csrf_token %}
    <input type="hidden" name="cedula" :value="data.id">
  </form>

</main>

<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script>
  function app() {
    return {
      timer: null,
      data: {
        id: "",
        personal : {
          name: "Giovanny Avila",
          position: "Programador",
          department: "",
          photo: ""
        },
        showFullId: "",
        defaultImage: "/static/images/default_assistent_image.jpg",
        formIsValid: null,
        greeting: "Descanse y reponga sus energias. ¡Hasta mañana!",
        welcomeMessages: [
          "¡Buenos días!",
          "Recuerda: todo lo que hagas hazlo de corazón y con mucho amor ¡ten un hermoso día!",
          "La dedicación y el trabajo arduo son las claves del éxito en cualquier emprendimiento. ¡Feliz Día!",
        ],
        goodBayMessages: [
          "Te voy a extrañar seriamente aquí. La mejor de las suertes para su nuevo esfuerzo y las aventuras interminables. ¡Nos vemos luego!",
          "Tus habilidades para tomar decisiones siempre me han inspirado a estar a tu nivel. ¡Hasta mañana!",
          "Tener un amigo como tú en el lugar de trabajo es un regalo ¡Descansa!",
        ],
        bepEffect: null,
        
      },
      audioEffect() {
        this.bepEffect = new Audio("/static/audio/checking_effect.wav")
      },
      playBep() {
        this.bepEffect.load()
        this.bepEffect.play()
      },
      initialize() {
        this.audioEffect()
        window.addEventListener("keyup", (e)=> {
          if (e.keyCode >= 96 && e.keyCode <= 105) {
            this.data.id = `${this.data.id}${e.key}`
          } else if (e.key == "enter" || e.keyCode == 13) {
            if (this.data.id != "") {
              this.$refs["idDisplayer"].value = this.data.id
              this.sendForm()
            }
          }
        })
      },
      sendForm() {
        const form = document.getElementById("checkingForm")
        const formData = new FormData(form)

        fetch(
          form.action,
          {
            method: "POST",
            body: formData
          }
        )
        .then(resp => resp.json())
        .then(resp => {
          console.log(resp)
          if (this.timer !== null) {
            clearTimeout(this.timer)
            this.timer = null
          }
          this.data.id = ""
          this.noticeCheckStatus(resp.error, resp.message, resp.checking_type, resp.user_data)
        })
      },
      noticeCheckStatus(hasError, message, checking_type, user_data) {
        this.playBep()
        if (hasError) {
          this.data.formIsValid = false
          this.data.greeting = message.cedula[0].message
        } else  {
          let greeting = []
          if (checking_type == "ENTRADA") {
            greeting =  this.data.welcomeMessages
          } else {
            greeting = this.data.goodBayMessages
          }
          this.data.greeting = greeting[Math.floor(Math.random()*greeting.length)];
          this.data.formIsValid = true
          this.data.personal = user_data
        }

        this.timer = setTimeout(() => {
          this.$refs["idDisplayer"].value = ""
          this.data.formIsValid = null
          this.data.id = ""
        }, 5000)
      }
    }
  }
</script>
</body>
</html>